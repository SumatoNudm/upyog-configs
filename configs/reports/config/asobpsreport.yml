ReportDefinitions:
- reportName: obpsApplicationReport
  decryptionPathId: StateTradeLicenseCancelledRegistryReport    
  summary: Building Plan Approval Application Report
  version: 1.0.0
  moduleName: rainmaker-obps
  sourceColumns:
    - name: application_no
      label: reports.obps.applicationno
      type: string
      source: obps
      showColumn: true
      total: false
    - name: normalappdate
      label: reports.obps.normalappdate
      type: epoch
      source: obps
      showColumn: false
    - name: created_time
      label: reports.obps.applicationdate
      type: string
      source: obps
      showColumn: true
    - name: edcr_number
      label: reports.obps.edcrnumber
      type: string
      source: obps
      showColumn: true
    - name: applicationchannel
      label: reports.obps.applicationchannel
      type: string
      source: obps
      showColumn: true
      isLocalisationRequired: true
    - name: name
      label: rainmaker.obps.name
      type: string
      source: obps
      showColumn: true
    - name: applicationtype
      label: reports.obps.applicationtype
      type: string
      source: obps
      showColumn: true
      isLocalisationRequired: true
    - name: occupancy_type
      label: reports.obps.occupancytype
      type: string
      source: obps
      showColumn: false
      isLocalisationRequired: true
    - name: status
      label: reports.obps.status
      type: string
      source: obps
      showColumn: true
      isLocalisationRequired: true
    - name: currentowner
      label: reports.obps.currentowner
      type: string
      source: obps
      showColumn: false
    - name: planning_permit_no
      label: reports.obps.planningpermitno
      type: string
      source: obps
      showColumn: true

  searchParams:
    - name: tenantid
      label: reports.obps.tenantid
      type: singlevaluelist
      pattern: 'http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.city.name'
      source: obps
      isMandatory: false
      searchClause: AND bp.tenant_id = $tenantid
    - name: fromdate
      label: reports.obps.fromdate
      type: epoch
      source: obps
      isMandatory: false
      searchClause: AND bp.created_time >= $fromdate
    - name: todate
      label: reports.obps.todate
      type: epoch
      source: obps
      isMandatory: false
      searchClause: AND bp.created_time <= $todate
    - name: applicationno
      label: reports.obps.applicationno
      type: string
      source: obps
      isMandatory: false
      searchClause: AND bp.application_no = $applicationno
    - name: status
      label: reports.obps.status
      type: singlevaluelist
      source: obps
      pattern: 'list://FORWARDED_TO_TECHNICAL_ENGINEER_GP:Forwarded to Technical Engineer (GP),CITIZEN_APPROVAL:Citizen Approval Pending/Completed,PENDING_RTP_APPROVAL:RTP Approval Pending,PENDING_CHAIRMAN_DA:Pending at Chairman (DA),PENDING_DA_ENGINEER:Pending at DA Engineer,PENDING_CHAIRMAN_PRESIDENT_MB:Pending at Chairman/President (MB),PENDING_FOR_SCRUTINY:Pending for Scrutiny,PAYMENT_PENDING:Payment Pending,PENDING_DD_AD_DEVELOPMENT_AUTHORITY:Pending at DD/AD Development Authority,GIS_VALIDATION:GIS Validation in Progress,CITIZEN_FINAL_PAYMENT:Citizen Final Payment Pending,APPLICATION_COMPLETED:Application Completed,FORWARDED_TO_TECHNICAL_ENGINEER_MB:Forwarded to Technical Engineer (MB),FORWARDED_TO_DD_AD_TCP:Forwarded to DD/AD (TCP)'
      isMandatory: false
      searchClause: AND bp.status = $status

  query: |
    SELECT 
      bp.application_no, 
      bp.application_date as normalappdate, 
      to_char(To_timestamp(bp.created_time / 1000), 'DD/MM/YYYY') as created_time,
      bp.edcr_number, 
      landinfo.channel as applicationchannel, 
      usr.name as name,
      bp.application_type as applicationtype, 
      land.occupancy_type, 
      bp.status, 
      case when st.isterminatestate=true then null else userassignee.name end as currentowner, 
      bp.planning_permit_no 
    FROM ug_bpa_buildingplans bp 
    INNER JOIN eg_wf_processinstance_v2 pi ON pi.businessid=bp.application_no 
    INNER JOIN (
      SELECT businessid, max(createdtime) as maxtime 
      FROM eg_wf_processinstance_v2 
      GROUP BY businessid
    ) wfg ON pi.businessid=wfg.businessid AND maxtime=pi.createdtime 
    INNER JOIN eg_wf_state_v2 st ON pi.status=st.uuid 
    INNER JOIN eg_user usr ON bp.created_by = usr.uuid  
    INNER JOIN ug_land_unit land ON land.land_info_id = bp.land_id 
    INNER JOIN ug_land_info landinfo ON land.land_info_id = landinfo.id 
    INNER JOIN ug_land_address adr ON adr.land_info_id = landinfo.id 
    INNER JOIN eg_user userassignee ON assigner = userassignee.uuid
    WHERE 1=1

  orderby: ORDER BY bp.application_date DESC

- reportName: obpsRegistryReport
  decryptionPathId: StateTradeLicenseCancelledRegistryReport    
  summary: OBPS Registry Report - Status Count
  version: 1.0.0
  moduleName: rainmaker-obps
  sourceColumns:
    - name: status_name
      label: reports.obps.status
      type: string
      source: obps
      showColumn: true
      isLocalisationRequired: true
    - name: count
      label: reports.obps.count
      type: number
      source: obps
      showColumn: true
      total: true

searchParams:
  - name: tenantid
    label: reports.obps.tenant
    type: singlevaluelist
    pattern: 'http://egov-mdms-service:8080/egov-mdms-service/v1/_get?tenantId=$tenantid&moduleName=tenant&masterName=tenants|$.MdmsRes.tenant.tenants.*.code|$.MdmsRes.tenant.tenants.*.city.name'
    source: obps
    isMandatory: false
    wrapper: true
    searchClause: AND tenantid = $tenantid
  - name: status_name
    label: reports.obps.status
    type: singlevaluelist
    pattern: 'list://FORWARDED_TO_TECHNICAL_ENGINEER_GP:Forwarded to Technical Engineer (GP),CITIZEN_APPROVAL:Citizen Approval Pending/Completed,PENDING_RTP_APPROVAL:RTP Approval Pending,PENDING_CHAIRMAN_DA:Pending at Chairman (DA),PENDING_DA_ENGINEER:Pending at DA Engineer,PENDING_CHAIRMAN_PRESIDENT_MB:Pending at Chairman/President (MB),PENDING_FOR_SCRUTINY:Pending for Scrutiny,PAYMENT_PENDING:Payment Pending,PENDING_DD_AD_DEVELOPMENT_AUTHORITY:Pending at DD/AD Development Authority,GIS_VALIDATION:GIS Validation in Progress,CITIZEN_FINAL_PAYMENT:Citizen Final Payment Pending,APPLICATION_COMPLETED:Application Completed,FORWARDED_TO_TECHNICAL_ENGINEER_MB:Forwarded to Technical Engineer (MB),FORWARDED_TO_DD_AD_TCP:Forwarded to DD/AD (TCP)'
    source: obps
    isMandatory: false
    wrapper: true
    searchClause: AND status = $status_name

    query: |
      SELECT
      status AS status_name,
      COUNT(*) AS count
      FROM ug_bpa_buildingplans
      WHERE status IN (
      'FORWARDED_TO_TECHNICAL_ENGINEER_GP',
      'CITIZEN_APPROVAL',
      'PENDING_RTP_APPROVAL',
      'PENDING_CHAIRMAN_DA',
      'PENDING_DA_ENGINEER',
      'PENDING_CHAIRMAN_PRESIDENT_MB',
      'PENDING_FOR_SCRUTINY',
      'PAYMENT_PENDING',
      'PENDING_DD_AD_DEVELOPMENT_AUTHORITY',
      'GIS_VALIDATION',
      'CITIZEN_FINAL_PAYMENT',
      'APPLICATION_COMPLETED',
      'FORWARDED_TO_TECHNICAL_ENGINEER_MB',
      'FORWARDED_TO_DD_AD_TCP'
      )
    groupby: GROUP BY status
